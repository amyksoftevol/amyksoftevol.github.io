<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
</head>
<body>

	<div style="width:100%;height:700px;margin:0 auto">
		<!-- <div style="text-align: center;">

			<button onclick="iframeUploader.chooseVideo()">Upload From Parent</button>
			<button onclick="iframeUploader.updateAuthToken('7777777777')">Update Auth Token</button>

		</div> -->
		<div id="iframeContainer" style="width:100%;height:100%;"></div>
	</div>
	<!-- <script src='https://dl.dropboxusercontent.com/s/fgt3pxdl3gulnw8/uploader.js'></script> -->

	<script>
		var IframeUploader = (function(window, undefined) {

			var IFRAME_SOURCE = 'iframeParent';
			// var IFRAME_SRC = 'http://dev.levelupmedia.tv/static/upload';
			var IFRAME_SRC = 'http://localhost:4200';
			// var IFRAME_ORIGIN = 'http://dev.levelupmedia.tv';
			var IFRAME_ORIGIN = 'http://localhost:4200';
			var iframeElement;
			var iframeOptions;

			function Message(messageType, options) {
				return {
					messageType: messageType,
					options: options
				}
			}

			function createIframeUploader(iframeContainerId, configuration) {
				setIframeUploaderOptions(configuration);
				var iframeContainer = document.getElementById(iframeContainerId)
				var iframe = document.createElement('iframe');
				iframe.src = IFRAME_SRC;
				iframe.frameBorder = '0';
				iframe.width = '100%';
				iframe.height = '100%';
				iframe.style.flexGrow = '1';
				iframe.onload = function() {
					iframeElement = iframe;
					configureIframeUploader();
				};
				iframeContainer.appendChild(iframe);
			}

			function setIframeUploaderOptions(configuration) {
				iframeOptions = configuration || {};
				iframeOptions.source = IFRAME_SOURCE;
			}

			function sendMessageToChildIframe(message) {
				iframeElement.contentWindow.postMessage(message, IFRAME_SRC);
			}

			function configureIframeUploader() {
				sendMessageToChildIframe(new Message('LOAD', iframeOptions));
			}

			function chooseVideo() {
				if (!iframeElement) {
					alert('Iframe isn\'t loaded...Please try again later!');
					return;
				}
				sendMessageToChildIframe(new Message('CHOOSE_VIDEO', iframeOptions));
			}

			function updateAuthToken(authToken) {
				iframeOptions.authToken = authToken;
				sendMessageToChildIframe(new Message('UPDATE_AUTH_TOKEN', iframeOptions));
			}

			// window.onIframeUploaderMessage = function(messageData) {}

			function sendMessageToParent(messageData) {
				var event = new CustomEvent('iframeMessage', {detail: messageData});
				window.dispatchEvent(event);
			}

			// window.addEventListener('message', function(event) {
			// 	if (event.origin !== IFRAME_ORIGIN) return;
			// 	var messageData = JSON.parse(event.data);
			// 	console.log('Message from CHILD: ', messageData);
			// 	window.onIframeUploaderMessage(messageData);
			// });

			window.addEventListener('message', function(event) {
				if (event.origin !== IFRAME_ORIGIN) return;
				var messageData = JSON.parse(event.data);
				console.log('Message from CHILD: ', messageData);
				sendMessageToParent(messageData);
			});

			return {
				chooseVideo: chooseVideo,
				createIframeUploader: createIframeUploader,
				updateAuthToken: updateAuthToken
			}

		}(window));
	</script>

	<script>
		var config = {
			authToken: "",
			// cssEmbedded: '.progress-bar-indicator{background-color:yellow;}.btn-main{background-color:yellow}.btn-confirmation-no{background-color:green}.container{padding: 20px;}',
			// cssExternal: "https://dl.dropbox.com/s/khutet5bmu9bl7w/styles.css"
		};
		IframeUploader.createIframeUploader('iframeContainer', config);
		// window.onIframeUploaderMessage = function(messageData) {
		// 	console.log('NEW MESSAGE DATA', messageData);
		// }	
		window.addEventListener("iframeMessage", function(event) {
		  console.log('CUSTOM EVENT', event);
		});

	</script>
	
</body>
</html>